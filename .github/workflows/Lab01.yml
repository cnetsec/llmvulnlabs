name: "🧪 Hacktiba 2025 — Lab01 Local (cache + modelo leve)"

on:
  workflow_dispatch:
    inputs:
      perguntas:
        description: "Perguntas (JSON array ou separadas por ||)"
        required: true
        type: string
      modelo:
        description: "HuggingFace model id (ex.: sshleifer/tiny-gpt2)"
        required: false
        type: string

jobs:
  lab01:
    runs-on: ubuntu-latest
    env:
      HF_HOME: ~/.cache/huggingface
      LAB01_MODEL: ${{ inputs.modelo || 'sshleifer/tiny-gpt2' }}

    steps:
      - name: "📥 Checkout"
        uses: actions/checkout@v4

      - name: "🐍 Setup Python"
        id: py
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "📦 Descobrir diretório de cache do pip"
        run: echo "PIP_CACHE_DIR=$(python -m pip cache dir)" >> $GITHUB_ENV

      - name: "🗄️ Cache pip"
        uses: actions/cache@v4
        with:
          path: ${{ env.PIP_CACHE_DIR }}
          key: pip-${{ runner.os }}-${{ steps.py.outputs.python-version }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: "🗄️ Cache Hugging Face (modelos)"
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-${{ env.LAB01_MODEL }}-v1
          restore-keys: |
            hf-${{ runner.os }}-

      - name: "📦 Instalar dependências (transformers + torch CPU)"
        run: |
          python -m pip install --upgrade pip
          pip install --quiet --index-url https://download.pytorch.org/whl/cpu torch
          pip install --quiet transformers

      - name: "🔥 Pré-baixar modelo (warm cache)"
        run: |
          python - <<'PY'
          import os
          from transformers import pipeline
          model = os.environ.get("LAB01_MODEL","sshleifer/tiny-gpt2")
          gen = pipeline("text-generation", model=model)
          gen("warmup", max_new_tokens=1)
          print(f"[warm] modelo pronto: {model}")
          PY

      - name: "▶️ Executar Lab01.py"
        env:
          LAB01_PERGUNTAS: ${{ inputs.perguntas }}
          LAB01_MODEL: ${{ env.LAB01_MODEL }}
        run: python Lab01.py
