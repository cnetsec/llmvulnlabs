name: 🧪 Hacktiba 2025 — Lab01 Vulnerabilidades

on:
  workflow_dispatch:
    inputs:
      python:
        description: "🐍 Versão do Python"
        required: true
        default: "3.11"
        type: choice
        options: ["3.10", "3.11", "3.12"]
      falhar_em_erro:
        description: "🚨 Falhar se houver erro na execução?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: read

jobs:
  lab01:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python }}
          cache: "pip"

      - name: 📦 Instalar dependências do projeto
        if: hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ▶️ Executar Lab01.py
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          set -e
          python Lab01.py || { echo "⚠️ Lab01.py retornou erro."; [ "${{ inputs.falhar_em_erro }}" = "true" ] && exit 1 || true; }

      - name: 🧾 Adicionar sumário (prévia de respostas)
        run: |
          echo "## Hacktiba 2025 — Lab01 Vulnerabilidades" >> $GITHUB_STEP_SUMMARY
          ULTIMO_JSON=$(ls -t resultados/labs/Lab01_*.json | head -n1)
          if [ -n "$ULTIMO_JSON" ]; then
            python - <<'PY' "$ULTIMO_JSON" >> $GITHUB_STEP_SUMMARY
import json, sys
with open(sys.argv[1], encoding="utf-8") as f:
    d = json.load(f)
print(f"**Execução UTC:** {d.get('timestamp_utc','?')}\n")
for bloco in d.get("resultados", []):
    print(f"### {bloco['titulo']}")
    for item in bloco["entradas"][:2]:
        q = item["pergunta"].replace("\n"," ")
        a = (item.get("resposta") or item.get("erro","")).replace("\n"," ")
        if len(a) > 200: a = a[:197] + "..."
        print(f"- **Pergunta:** {q}\n  - _Resposta (resumo)_: {a}\n")
    print()
PY
          fi

      - name: 📤 Publicar artefatos
        uses: actions/upload-artifact@v4
        with:
          name: Hacktiba2025-Lab01
          path: |
            resultados/labs/Lab01_*.md
            resultados/labs/Lab01_*.json
          if-no-files-found: error
