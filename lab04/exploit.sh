#!/bin/bash
set -e

RESULT_FILE="garak_result.json"
API_PORT=8000

# ===============================
# 1. Esperar API estar de pé
# ===============================
echo "[*] Checando se a API vulnerável está no ar..."
until curl -s http://127.0.0.1:$API_PORT/chat -X POST \
    -H "Content-Type: application/json" \
    -d '{"prompt":"ping"}' > /dev/null 2>&1; do
    echo "   ... aguardando API responder"
    sleep 2
done
echo "[*] API está pronta, iniciando ataque..."

# ===============================
# 2. Rodar Garak
# ===============================
python3 -m garak \
  --model_type rest \
  --model_name rest_victim.yaml \
  --probes encoding,promptinject,dan.Dan_11_0 \
  --output $RESULT_FILE \
  --format json | tee garak_output.log

echo "[*] Resultados salvos em $RESULT_FILE"
