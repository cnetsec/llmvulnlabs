#!/bin/bash
set -e

RESULT_FILE="garak_result.json"

# ===============================
# 1. Validar que Ollama está rodando
# ===============================
echo "[*] Checando se Ollama está ativo..."
until curl -s http://127.0.0.1:11434/api/tags > /dev/null 2>&1; do
    echo "   ... aguardando Ollama"
    sleep 2
done
echo "[*] Ollama está pronto, iniciando Garak..."

# ===============================
# 2. Rodar Garak
# ===============================
python3 -m garak \
  --model_type rest \
  --model_name rest_ollama.yaml \
  --probes encoding,promptinject,dan.Dan_11_0 \
  --output $RESULT_FILE \
  --format json | tee garak_output.log

echo "[*] Resultados salvos em $RESULT_FILE"
